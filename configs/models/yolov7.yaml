# YOLOv7 模型架構設定檔 (Model Architecture Configuration)
#
# 此檔案定義了 YOLOv7 標準版的網路架構。
# YOLOv7 使用 E-ELAN (Extended Efficient Layer Aggregation Network) 作為骨幹網路，
# 這是一種高效的特徵提取架構，能夠在不增加推論成本的情況下提升準確度。
#
# 網路架構概述:
# 1. Backbone (骨幹網路): 負責從輸入影像中提取特徵
# 2. Neck (頸部網路): 使用 FPN + PAN 進行多尺度特徵融合
# 3. Head (檢測頭): 輸出最終的檢測結果
#
# 參考資料: https://github.com/WongKinYiu/yolov7

# ==================================================
# 基本參數 (Basic Parameters)
# ==================================================

# 類別數量 (Number of Classes)
# 這個值會在訓練時被資料集設定檔覆蓋
nc: 80

# 檢測層深度倍數 (Depth Multiple)
# 控制網路的深度，數值越大網路越深
depthMultiple: 1.0

# 檢測層寬度倍數 (Width Multiple)
# 控制每層的通道數，數值越大通道數越多
widthMultiple: 1.0

# ==================================================
# 錨點框設定 (Anchor Boxes)
# ==================================================
#
# 錨點框 (Anchor Boxes) 是預先定義的邊界框尺寸，用於幫助模型預測物體位置。
# YOLOv7 在三個不同尺度上進行檢測，每個尺度有 3 個錨點框。
#
# 尺度說明:
# - P3 (小物體): 對應 8x 下採樣的特徵圖，使用較小的錨點框
# - P4 (中物體): 對應 16x 下採樣的特徵圖，使用中等的錨點框
# - P5 (大物體): 對應 32x 下採樣的特徵圖，使用較大的錨點框

anchors:
  - [12, 16, 19, 36, 40, 28]       # P3/8  (小物體錨點框)
  - [36, 75, 76, 55, 72, 146]      # P4/16 (中物體錨點框)
  - [142, 110, 192, 243, 459, 401] # P5/32 (大物體錨點框)

# ==================================================
# 骨幹網路架構 (Backbone Architecture)
# ==================================================
#
# 每行格式: [from, number, module, args]
# - from: 輸入來源層的索引 (-1 表示前一層)
# - number: 模組重複次數
# - module: 模組類型名稱
# - args: 模組參數列表
#
# E-ELAN 架構特點:
# 1. 使用多分支結構增加特徵多樣性
# 2. 保持推論效率的同時提升準確度
# 3. 使用 SPPCSPC (Spatial Pyramid Pooling - Cross Stage Partial Connection)
#    來擴大感受野

backbone:
  # ============= Stem =============
  # 輸入處理層，將 RGB 影像轉換為初始特徵
  # 輸入: [3, H, W] -> 輸出: [32, H/2, W/2]
  - [-1, 1, Conv, [32, 3, 1]]       # 0: 3x3 卷積，32 通道

  # ============= Stage 1 (P1/2) =============
  # 第一階段下採樣
  - [-1, 1, Conv, [64, 3, 2]]       # 1: 下採樣到 H/2
  - [-1, 1, Conv, [64, 3, 1]]       # 2

  # ============= Stage 2 (P2/4) =============
  # 第二階段 E-ELAN 模組
  - [-1, 1, Conv, [128, 3, 2]]      # 3: 下採樣到 H/4
  - [-1, 1, ELANBlock, [256, 64]]   # 4: E-ELAN 模組

  # ============= Stage 3 (P3/8) =============
  # 第三階段 E-ELAN 模組 (小物體特徵層)
  - [-1, 1, MPConv, [256]]          # 5: MaxPool + Conv 下採樣到 H/8
  - [-1, 1, ELANBlock, [512, 128]]  # 6: E-ELAN 模組 (輸出給 Neck)

  # ============= Stage 4 (P4/16) =============
  # 第四階段 E-ELAN 模組 (中物體特徵層)
  - [-1, 1, MPConv, [512]]          # 7: 下採樣到 H/16
  - [-1, 1, ELANBlock, [1024, 256]] # 8: E-ELAN 模組 (輸出給 Neck)

  # ============= Stage 5 (P5/32) =============
  # 第五階段 E-ELAN 模組 (大物體特徵層)
  - [-1, 1, MPConv, [1024]]         # 9: 下採樣到 H/32
  - [-1, 1, ELANBlock, [1024, 256]] # 10: E-ELAN 模組

  # ============= SPPCSPC =============
  # 空間金字塔池化模組，擴大感受野
  - [-1, 1, SPPCSPC, [512]]         # 11: SPPCSPC (輸出給 Neck)

# ==================================================
# 頸部網路架構 (Neck Architecture)
# ==================================================
#
# FPN (Feature Pyramid Network) + PAN (Path Aggregation Network)
#
# FPN 自頂向下傳遞語義資訊:
#   高層特徵 (語義豐富) -> 低層特徵 (細節豐富)
#
# PAN 自底向上傳遞定位資訊:
#   低層特徵 (定位準確) -> 高層特徵 (感受野大)
#
# 這種雙向特徵融合可以同時保留語義資訊和空間細節。

neck:
  # ============= FPN 自頂向下 (Top-Down) =============
  # 從 P5 向 P3 傳遞高層語義資訊

  # 上採樣並與 P4 融合
  - [-1, 1, Conv, [256, 1, 1]]      # 12: 1x1 卷積降維
  - [-1, 1, Upsample, [2]]          # 13: 2x 上採樣
  - [8, 1, Conv, [256, 1, 1]]       # 14: 處理 P4 特徵 (來自 backbone 層 8)
  - [[-1, -2], 1, Concat, [1]]      # 15: 特徵拼接
  - [-1, 1, ELANBlock, [256, 64]]   # 16: E-ELAN 融合

  # 上採樣並與 P3 融合
  - [-1, 1, Conv, [128, 1, 1]]      # 17: 1x1 卷積降維
  - [-1, 1, Upsample, [2]]          # 18: 2x 上採樣
  - [6, 1, Conv, [128, 1, 1]]       # 19: 處理 P3 特徵 (來自 backbone 層 6)
  - [[-1, -2], 1, Concat, [1]]      # 20: 特徵拼接
  - [-1, 1, ELANBlock, [128, 32]]   # 21: E-ELAN 融合 (P3 輸出)

  # ============= PAN 自底向上 (Bottom-Up) =============
  # 從 P3 向 P5 傳遞低層定位資訊

  # 下採樣並與 P4 融合
  - [-1, 1, MPConv, [128]]          # 22: 下採樣
  - [[-1, 16], 1, Concat, [1]]      # 23: 與 FPN P4 拼接
  - [-1, 1, ELANBlock, [256, 64]]   # 24: E-ELAN 融合 (P4 輸出)

  # 下採樣並與 P5 融合
  - [-1, 1, MPConv, [256]]          # 25: 下採樣
  - [[-1, 11], 1, Concat, [1]]      # 26: 與 SPPCSPC 輸出拼接
  - [-1, 1, ELANBlock, [512, 128]]  # 27: E-ELAN 融合 (P5 輸出)

# ==================================================
# 檢測頭架構 (Detection Head Architecture)
# ==================================================
#
# 檢測頭在三個尺度上輸出預測結果:
# - P3: 80x80 特徵圖，檢測小物體
# - P4: 40x40 特徵圖，檢測中物體
# - P5: 20x20 特徵圖，檢測大物體
#
# 每個檢測頭輸出: [num_anchors * (5 + num_classes), H, W]
# - 5 = 4 (邊界框座標) + 1 (物件性分數)

head:
  # P3 檢測頭準備
  - [21, 1, RepConv, [256, 3, 1]]   # 28: P3 特徵處理

  # P4 檢測頭準備
  - [24, 1, RepConv, [512, 3, 1]]   # 29: P4 特徵處理

  # P5 檢測頭準備
  - [27, 1, RepConv, [1024, 3, 1]]  # 30: P5 特徵處理

  # 檢測層 (Detect Layer)
  # 整合三個尺度的輸出
  - [[28, 29, 30], 1, Detect, [nc, anchors]]  # 31: 最終檢測輸出

# ==================================================
# 模型參數統計 (Model Statistics)
# ==================================================
#
# YOLOv7 標準版 (640x640 輸入):
# - 參數量: ~37.2M
# - FLOPs: ~104.7G
# - 推論速度: ~161 FPS (V100 GPU)
# - COCO mAP: 51.2%
#
# 這些數值會根據輸入尺寸和硬體而有所不同。
